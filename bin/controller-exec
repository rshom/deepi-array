#!/bin/sh
# Run through a series of autofunctions whenever the array is powered on

echo "INFO: Controller powered on"

min_hd_space=$((1024*1024))	# 1 GB
savedir=/mnt/volume

ifaceup () {
    file=/sys/class/net/$1/operstate
    
    if [ -f "$file" ]; then
	    status=$(cat $file)
	    # status is likely but not definitely "up"
        # could be "unknown"
    else
        # if no file, it is "down"
	    status="down"
    fi
    
    echo "INFO: iface $1: $status"
    
    if [ ! "$status" = "down" ]; then
	    return 0
    else
	    return 1
    fi
}

backup_node () {

    echo "INFO: backing up $1"

    viddir=$savedir/$1/Videos/
    logdir=$savedir/$1/logs/
    
    if [ ! -d "$logdir" ];
    then
	echo "INFO: Creating log backup dir: $logdir"
	mkdir -p $logdir || echo "ERROR: Failed to create $logdir"
    else
	echo "DEBUG: $logdir exists"
    fi
    
    if [ ! -d "$viddir" ];
    then
	echo "INFO: video backup dir: $viddir"
	mkdir -p $viddir || echo "ERROR: Failed to create $viddir"
    else
	echo "DEBUG: $viddir exists"
    fi
    
    rsync -vrltD --progress --stats --timeout=20 pi@$1:logs/*.log $logdir || echo "ERROR: Back up $1 logs failed."
    rsync -vrltD --progress --stats --timeout=20 pi@$1:Videos/*.h264 $viddir || echo "ERROR: back up $1 videos failed."

    return $?
}


timedatectl status
echo "INFO: Syncing time"	# TODO
sudo hwclock -s || echo "ERROR: timesync failed"
timedatectl status


# Check network interfaces
echo "Waiting give time for nodes to boot up";
sleep 20;
sudo resethub || echo "ERROR: reset hub failed"
sleep 5; 
/home/pi/deepi-array/bin/wait_for_connections || echo "ERROR: Wait for connections script failed"

sudo /home/pi/deepi-array/bin/lights_on || echo "ERROR: failed to turn on lights"

echo "INFO: Executing node commands"
parallel-ssh -h /home/pi/hosts.txt "sh /home/pi/node-exec | ts &> /home/pi/logs/$(date +%Y%m%d%H%M).log"

sudo /home/pi/deepi-array/bin/lights_off || echo "ERROR: failed to turn off lights"

# Check hard drive space
echo "INFO: mounting harddrive"
sudo mount -a || echo "ERROR: harddrive failed to mount"
if ! mountpoint -q $savedir
then
    echo "WARNING: Hardrive not detected"
    savedir=/home/pi/
fi
echo "INFO: backing up to $savedir"

free_space=`df --output=avail $savedir | tail -n1`
echo "INFO: Free space: $free_space ($((free_space/1024/1024)) GB)"


echo "INFO: backing up controller logs"
rsync -vrltD --progress --stats --timeout=20 /home/pi/logs/ $savedir || echo "ERROR: back up of controller logs failed."

# If space back up nodes
if [ "$free_space" -lt "$min_hd_space" ]
then
    echo "ERROR: not enough space"
    # TODO: quit
else
    echo "INFO: Backing up nodes"
    for n in 1 2 3 4 5 6
    do
	if ifaceup usb$n
	then
        echo "INFO: Backing up 10.0.1$n.2"
	    backup_node "10.0.1$n.2" || echo "ERROR: Back up 10.0.1$n.2 failed"
	else
	    echo "WARNING: Back up 10.0.1$n.2 skipped"
	fi
    done
    echo "DEBUG: waiting for backups to complete"
    wait # FIXME: no longer needed
    echo "DEBUG: backups complete"
fi   

echo "INFO: controller-exec completed"

# Stay up if there is an outside connection
ifaceup eth0; eth0_up=$?
ifaceup wlan0; wlan0_up=$?

echo "DEBUG: wlan0: $wlan0_up";
echo "DEBUG: eth0 : $eth0_up";

if  [ $eth0_up -eq 0 ] ||  [ $wlan0_up -eq 0 ]
then
    echo "INFO: Outside connection detected: Staying up"
    exit 0
else
    echo "INFO: No outside connection. Shutting down"
    parallel-ssh -h /home/pi/hosts.txt "sudo shutdown now"
    sleep 10 # give time to shutdown
    echo "INFO: shutting down controller"
    sudo shutdown now
fi

exit 0

