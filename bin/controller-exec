#!/bin/sh
# Run through a series of autofunctions whenever the array is powered on


min_hd_space=$((1024*1024))	# 1 GB
savedir=/mnt/usb1

echo "INFO: Controller powered on"

ifaceup () {
    file=/sys/class/net/$1/operstate
    
    if [ -f "$file" ]; then
	status=$(cat $file)
	# status is likely but not definitely "up"
    else
	status="down"
    fi
    
    echo "INFO: iface $1: $status"
    
    if [ ! "$status" = "down" ]; then
	return 0
    else
	return 1
    fi
}

backup_node () {

    echo "INFO: backing up $1"

    viddir=$savedir/$1/Videos
    logdir=$savedir/$1/log
    
    if [ ! -d "$logdir" ];
    then
	echo "INFO: Creating log backup dir: $logdir"
	mkdir -p $logdir || echo "ERROR: Failed to create $logdir"
    else
	echo "DEBUG: $logdir exists"
    fi
    
    if [ ! -d "$viddir" ];
    then
	echo "INFO: video backup dir: $viddir"
	mkdir -p $viddir || echo "ERROR: Failed to create $viddir"
    else
	echo "DEBUG: $viddir exists"
    fi
    
    rsync -v --timeout=20 -a pi@$1:logs/ $logdir 
    rsync -v --timeout=20 -a pi@$1:Videos/ $viddir

    return $?
}


# TODO: pipe to logger

echo "INFO: Controller powered on"
echo "INFO: Syncing time"	# TODO

# Check network interfaces
/home/pi/deepi-array/wait_for_connections || "Wait for connections script failed"

# Check hard drive space
if ! mountpoint -q $savedir
then
    echo "WARNING: Hardrive not detected"
    savedir=/home/pi
else
    savedir=/mnt/usb1
fi
echo "INFO: backing up to $savedir"

free_space=`df --output=avail $savedir | tail -n1`
echo "INFO: Free space: $free_space ($((free_space/1024/1024)) GB)"


# If space back up nodes
if [ "$free_space" -lt "$min_hd_space" ]
then
    echo "ERROR: not enough space"
    # TODO: quit
else
    echo "INFO: Backing up nodes"
    for n in 1 2 3 4 5 6
    do
	if ifaceup usb$n
	then
        echo "INFO: Backing up 10.0.1$n.2"
	    backup_node "10.0.1$n.2" || echo "ERROR: Back up 10.0.1$n.2 failed"
	else
	    echo "WARNING: Back up 10.0.1$n.2 skipped"
	fi
    done
    echo "DEBUG: waiting for backups to complete"
    wait
    echo "DEBUG: backups complete"
fi   

# Stay up if there is an outside connection
ifaceup eth0; eth0_up=$1
ifaceup wlan0; wlan0_up=$1

# Check if user is logged in
# NOTE: should not matter
if who | grep -q "pi"
then
    echo "INFO: pi is logged in: Staying up"
    exit 0
else
    echo "INFO: pi is not logged in"
fi

echo "INFO: controller-exec completed"

if  $eth0_up || $wlan0_up 
then
    echo "INFO: Outside connection detected: Staying up"
    exit 0
else
    echo "INFO: No outside connection. Shutting down"
    sudo shutdown now
fi

exit 0

